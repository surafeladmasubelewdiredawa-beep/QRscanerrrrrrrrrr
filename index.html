<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professional QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #edb200e8;
      --primary-dark: #5a5056;
      --secondary: #edb200;
      --error: #edb200e8;
      --success: #edb200e8;
      --warning: #edb200e8;
      --background: #33011f;
      --surface: #13060d00;
      --on-surface: #f8fafc;
      --on-surface-secondary: #cbd5e1;
      --error-text: #44020b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #e0e0e0;
      background-color: var(--background);
      position: relative;
      overflow: hidden;
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100%;
    }
    
    .scanner-section {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #000;
      overflow: hidden;
    }
    
    .controls-container {
      position: fixed;
      bottom: 15px;
      left: 0;
      right: 0;
      padding: 10px;
      z-index: 10;
      display: flex;
      justify-content: center;
    }
    
    .history-section {
      position: fixed;
      top: 0;
      right: 0;
      width: 85%;
      max-width: 320px;
      height: 100vh;
      background-color: var(--surface);
      padding: 15px;
      box-shadow: -2px 0 15px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      z-index: 100;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .history-section.active {
      transform: translateX(0);
    }
    
    .toggle-history {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 101;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18M3 6h18M3 18h18"/></svg>');      
      background-size: 55%;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .status {
      display: none;
    }
    
    .timer {
      position: fixed;
      top: 15px;
      left: 15px;
      font-size: 13px;
      font-weight: bold;
      color: var(--secondary);
      background-color: rgba(0, 0, 0, 0.6);
      padding: 6px 12px;
      border-radius: 20px;
      z-index: 10;
      backdrop-filter: blur(4px);
    }
    
    .scanner-container {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      display: none;
    }
    
    .scanner-guide {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70vmin;
      height: 70vmin;
      max-width: 300px;
      max-height: 300px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3);
    }
    
    .scanner-line {
      position: absolute;
      height: 2px;
      width: 100%;
      background-color: var(--secondary);
      top: 0;
      animation: scan 2s infinite ease-in-out;
    }
    
    @keyframes scan {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }
    
    #result {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 15px 20px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      display: none;
      z-index: 20;
      text-align: center;
      max-width: 85%;
      word-break: break-word;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.15);
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -40%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    
    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    
    .btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      background-size: 60%;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-3px);
    }
    
    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    .btn-file { 
      background-color: var(--warning);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>');    }
    .btn-start { 
      background-color: var(--success);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>');    }
    .btn-stop { 
      background-color: var(--error);
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>');
    }
    
    input[type="file"] {
      display: none;
    }
    
    .history {
      background-color: #080808e8;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 15px #0e0e0d00;
      height: calc(94% - 30px);
      display: flex;
      flex-direction: column;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .history-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: var(--on-surface);
    }
    
    .history-count {
      font-size: 12px;
      color: var(--on-surface-secondary);
      background-color: rgba(255, 255, 255, 0.1);
      padding: 4px 8px;
      margin-right: 13%;
      border-radius: 12px;
    }
    
    .history-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 15px;
    }
    
    .empty-history {
      color: var(--on-surface-secondary);
      text-align: center;
      padding: 30px 15px;
      font-size: 14px;
    }
    
    .history-item {
      padding: 12px;
      margin-bottom: 10px;
      background-color: rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
      border-left: 4px solid var(--primary);
    }
    
    .history-item:active {
      background-color: rgba(255, 255, 255, 0.12);
    }
    
    .history-item-content {
      flex: 1;
      word-break: break-word;
      font-size: 13px;
      padding-right: 10px;
    }
    
    .history-item-number {
      font-weight: 600;
      margin-right: 8px;
      color: var(--secondary);
      min-width: 20px;
    }
    
    .history-item-actions {
      display: flex;
      gap: 8px;
    }
    
    .history-item-btn {
      background: none;
      border: none;
      color: var(--on-surface-secondary);
      cursor: pointer;
      padding: 5px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .history-item-btn:active {
      color: var(--on-surface);
      background-color: rgba(255, 255, 255, 0.15);
    }
    
    .history-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .history-btn {
      flex: 1;
      padding: 10px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    .history-btn:active {
      transform: translateY(1px);
    }
    
    .history-clear {
      background-color: var(--error);
    }
    
    .history-download {
      background-color: var(--primary);
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #334155;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      max-width: 85%;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .toast.show {
      opacity: 1;
    }
    
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .error-text {
      color: var(--error-text);
    }
    
    .camera-permission {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: white;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 25px;
      border-radius: 14px;
      max-width: 85%;
      z-index: 5;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .camera-permission p {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .camera-permission button {
      margin-top: 15px;
      padding: 12px 24px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .camera-permission button:active {
      transform: translateY(1px);
      background-color: var(--primary-dark);
    }
    
    @media (max-width: 480px) {
      .controls {
        gap: 15px;
      }
      
      .btn {
        width: 55px;
        height: 55px;
        font-size: 22px;
      }
      
      #result {
        font-size: 14px;
        padding: 12px 16px;
        max-width: 90%;
      }
      
      .scanner-guide {
        width: 65vmin;
        height: 65vmin;
      }
      
      .history-section {
        width: 90%;
        padding: 12px;
      }
    }

    @media (max-height: 600px) {
      .btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      
      .controls {
        gap: 12px;
      }
      
      .scanner-guide {
        width: 60vmin;
        height: 60vmin;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <button class="toggle-history" onclick="toggleHistory()"></button>
    
    <div class="scanner-section">
      <p class="status" id="status">Ready to scan</p>
      <div class="timer" id="timer">30:00</div>
      
      <div class="scanner-container" id="scannerBox">
        <video id="scanner" playsinline></video>
        <div class="scanner-overlay" id="scannerOverlay">
          <div class="scanner-guide">
            <div class="scanner-line"></div>
          </div>
        </div>
        <div id="result"></div>
        <div class="camera-permission" id="cameraPermission" style="display: none;">
          <p>Camera access is required to scan QR codes.</p>
          <p>Please allow camera permissions in your browser settings.</p>
          <button onclick="requestCameraPermission()">Grant Permission</button>
        </div>
    </div>

    <div class="controls-container">
      <div class="controls">
        <button class="btn btn-start" onclick="toggleCamera()" id="startBtn"></button>
        <button class="btn btn-file" onclick="document.getElementById('fileInput').click()" id="fileBtn"></button>
      </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*" />
  </div>
  
  <div class="history-section" id="historySection">
    <div class="history">
      <div class="history-header">
        <h2 class="history-title">Scan History</h2>
        <div class="history-count" id="historyCount">0 items</div>
      </div>
      
      <div class="history-list" id="historyList">
        <div class="empty-history">No scans yet</div>
      </div>
      
      <div class="history-controls">
        <button class="history-btn history-clear" onclick="clearHistory()" id="clearBtn">
          <span>Clear All</span>
        </button>
        <button class="history-btn history-download" onclick="downloadPDF()" id="downloadBtn">
          <span>Export PDF</span>
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <!-- Audio element for beep sound with fallback -->
  <audio id="beepSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-beep-success-872.mp3" type="audio/mpeg">
  </audio>

  <script>
    // DOM Elements
    const video = document.getElementById("scanner");
    const fileInput = document.getElementById("fileInput");
    const resultDiv = document.getElementById("result");
    const scannerBox = document.getElementById("scannerBox");
    const scannerOverlay = document.getElementById("scannerOverlay");
    const statusText = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const fileBtn = document.getElementById("fileBtn");
    const clearBtn = document.getElementById("clearBtn");
    const historyList = document.getElementById("historyList");
    const historyCount = document.getElementById("historyCount");
    const toast = document.getElementById("toast");
    const beepSound = document.getElementById("beepSound");
    const timerDisplay = document.getElementById("timer");
    const downloadBtn = document.getElementById("downloadBtn");
    const historySection = document.getElementById("historySection");
    const cameraPermission = document.getElementById("cameraPermission");

    // App State
    let stream = null;
    let scanning = false;
    let scanHistory = [];
    let currentScanNumber = 1;
    let lastScannedContent = null;
    let duplicateWarningTimeout = null;
    let scannerTimeout = null;
    let scanTimer = null;
    let timeLeft = 30 * 60; // 30 minutes in seconds
    let timerActive = false;
    let isPausedForResultDisplay = false;

    // Initialize from localStorage
    function initializeFromStorage() {
      try {
        const savedHistory = localStorage.getItem('qrScanHistory');
        if (savedHistory) {
          scanHistory = JSON.parse(savedHistory);
          currentScanNumber = scanHistory.length > 0 ? scanHistory[scanHistory.length - 1].number + 1 : 1;
          updateHistoryDisplay();
          updateHistoryCount();
        }
      } catch (e) {
        console.error("Error loading history from storage:", e);
        clearLocalStorage();
      }
    }

    // Clear corrupted localStorage
    function clearLocalStorage() {
      localStorage.removeItem('qrScanHistory');
      scanHistory = [];
      currentScanNumber = 1;
      updateHistoryDisplay();
      updateHistoryCount();
    }

    // Initialize on load
    initializeFromStorage();

    // Event Listeners
    fileInput.addEventListener('change', handleFileUpload);

    // Toggle history panel
    function toggleHistory() {
      historySection.classList.toggle('active');
    }

    // Functions
    function playBeep() {
      try {
        if (beepSound.readyState >= HTMLMediaElement.HAVE_ENOUGH_DATA) {
          beepSound.currentTime = 0;
          beepSound.play().catch(e => console.log("Beep play error:", e));
        }
      } catch (e) {
        console.log("Beep error:", e);
      }
    }

    function vibrate() {
      // Check if vibration API is supported
      if (navigator.vibrate) {
        // Vibrate for 1 second (500ms)
        navigator.vibrate(1000);
      }
    }

    function startTimer() {
      timerDisplay.style.display = 'block';
      timeLeft = 30 * 60; // 30 minutes in seconds
      timerActive = true;
      updateTimerDisplay();
      
      scanTimer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
          stopTimer();
          disableAllButtonsExceptPDF();
        }
      }, 1000); // Update every second
    }
    
    function stopTimer() {
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      timerActive = false;
      timerDisplay.textContent = "Time expired";
    }
    
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function disableAllButtonsExceptPDF() {
      fileBtn.disabled = true;
      startBtn.disabled = true;
      clearBtn.disabled = true;
      
      fileBtn.classList.add('disabled');
      startBtn.classList.add('disabled');
      clearBtn.classList.add('disabled');
      
      stopCamera();
      
      showStatus("Scanning time expired");
      showToast("Scanning time has ended.");
    }

    function enableAllButtons() {
      fileBtn.disabled = false;
      startBtn.disabled = false;
      clearBtn.disabled = scanHistory.length === 0;
      
      fileBtn.classList.remove('disabled');
      startBtn.classList.remove('disabled');
      clearBtn.classList.remove('disabled');
      
      timerDisplay.style.display = 'none';
      timerActive = false;
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      
      showStatus("Ready to scan");
      showToast("Buttons re-enabled");
    }

    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;

      showStatus("Processing image...");
      
      const reader = FileReader ? new FileReader() : new ActiveXObject('Scripting.FileSystemObject');
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          
          // Set canvas dimensions to match the image
          canvas.width = img.width;
          canvas.height = img.height;
          
          // Draw the image on the canvas
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          try {
            // Get the image data from the canvas
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Try to decode the QR code with different options
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "attemptBoth", // Try both normal and inverted
            });
            
            if (code) {
              playBeep();
              vibrate(); // Add vibration on successful scan
              processScannedCode(code.data);
              if (!timerActive) {
                startTimer();
              }
            } else {
              // If no QR code found, try with a different approach
              showCurrentResult("❌ No QR code found");
              showStatus("No QR code in image", true);
              
              // Additional debugging: try to enhance the image and try again
              tryEnhancedDetection(canvas, ctx);
            }
          } catch (error) {
            showCurrentResult("❌ Error processing image");
            showStatus("Image processing error", true);
            console.error(error);
          }
        };
        img.onerror = () => {
          showCurrentResult("❌ Invalid image");
          showStatus("Invalid image file", true);
        };
        img.src = ev.target.result;
      };
      reader.onerror = () => {
        showCurrentResult("❌ Error reading file");
        showStatus("File read error", true);
      };
      reader.readAsDataURL(file);
    }

    // Enhanced detection function for difficult QR codes
    function tryEnhancedDetection(canvas, ctx) {
      // Create a temporary canvas for image processing
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      
      // Set dimensions
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      
      // Try different image processing techniques
      const techniques = [
        () => {
          // Technique 1: Convert to grayscale
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          // Technique 2: Increase contrast
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          const factor = 1.5;
          
          for (let i = 0; i < data.length; i += 4) {
            data[i] = factor * (data[i] - 128) + 128;
            data[i + 1] = factor * (data[i + 1] - 128) + 128;
            data[i + 2] = factor * (data[i + 2] - 128) + 128;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          // Technique 3: Try with original image but different settings
          return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
      ];
      
      // Try each technique
      for (let i = 0; i < techniques.length; i++) {
        try {
          const processedImageData = techniques[i]();
          const code = jsQR(processedImageData.data, processedImageData.width, processedImageData.height, {
            inversionAttempts: "attemptBoth",
          });
          
          if (code) {
            playBeep();
            vibrate(); // Add vibration on successful scan
            processScannedCode(code.data);
            if (!timerActive) {
              startTimer();
            }
            return;
          }
        } catch (error) {
          console.log("Enhanced technique failed:", error);
        }
      }
    }

    function requestCameraPermission() {
      cameraPermission.style.display = 'none';
      startCamera();
    }

    // Toggle camera function - replaces separate start/stop functions
    function toggleCamera() {
      if (scanning) {
        stopCamera();
      } else {
        startCamera();
      }
    }

    function startCamera() {
      if (timerActive && timeLeft <= 0) {
        showToast("Scanning time has expired");
        return;
      }

      resultDiv.style.display = 'none';
      showStatus("Starting camera...");
      fileBtn.disabled = true;
      
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("Camera not supported", true);
        fileBtn.disabled = false;
        cameraPermission.style.display = 'block';
        return;
      }

      if (!timerActive) {
        startTimer();
      }

      // Try to get camera with environment facing mode (rear camera)
      navigator.mediaDevices.getUserMedia({ 
        video: { 
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        } 
      })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = 'block';
        scannerOverlay.style.display = 'block';
        scannerBox.classList.add('active');
        showStatus("Scanning..");
        
        video.onplaying = () => {
          scanning = true;
          // Update button to show stop state
          startBtn.classList.remove('btn-start');
          startBtn.classList.add('btn-stop');
          scanFrame();
        };
        
        video.onerror = () => {
          showStatus("Camera error", true);
          stopCamera();
        };
        
        video.play().catch(err => {
          showStatus("Error starting camera", true);
          console.error(err);
          stopCamera();
        });
      })
      .catch(err => {
        console.error("Camera access error:", err);
        
        // If environment camera fails, try user-facing (front) camera
        navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          } 
        })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.style.display = 'block';
          scannerOverlay.style.display = 'block';
          scannerBox.classList.add('active');
          showStatus("Scanning with front camera..");
          
          video.onplaying = () => {
            scanning = true;
            // Update button to show stop state
            startBtn.classList.remove('btn-start');
            startBtn.classList.add('btn-stop');
            scanFrame();
          };
        })
        .catch(err => {
          console.error("Front camera also failed:", err);
          showStatus("Camera access denied", true);
          fileBtn.disabled = false;
          cameraPermission.style.display = 'block';
          
          if (err.name === 'NotAllowedError') {
            showToast("Please enable camera permissions in your browser settings");
          } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
            showToast("No camera found on this device");
          }
        });
      });
    }

    function stopCamera() {
      scanning = false;
      fileBtn.disabled = false;
      video.pause();
      video.style.display = 'none';
      scannerOverlay.style.display = 'none';
      scannerBox.classList.remove('active');
      showStatus("Camera stopped");
      
      // Update button to show start state
      startBtn.classList.remove('btn-stop');
      startBtn.classList.add('btn-start');
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      if (scannerTimeout) {
        clearTimeout(scannerTimeout);
        scannerTimeout = null;
      }
    }

    function scanFrame() {
      if (!scanning || isPausedForResultDisplay || (timerActive && timeLeft <= 0)) {
        return;
      }
      
      try {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: "dontInvert",
          });
          
          if (code) {
            playBeep();
            vibrate(); // Add vibration on successful scan
            processScannedCode(code.data);
            return;
          }
        }
        scannerTimeout = requestAnimationFrame(scanFrame);
      } catch (error) {
        console.error("Scan error:", error);
        showStatus("Scan error occurred", true);
        stopCamera();
      }
    }

    function processScannedCode(content) {
      if (!content || content.trim() === "") {
        showCurrentResult("❌ Empty QR code");
        showStatus("Empty QR code content", true);
        return;
      }

      if (content === lastScannedContent) {
        showDuplicateWarning();
        return;
      }

      const isDuplicate = scanHistory.some(item => item.content === content);
      
      if (isDuplicate) {
        showDuplicateWarning();
        return;
      }

      lastScannedContent = content;
      addToHistory(content);
      showCurrentResult(content);
      showStatus("Scan successful!");
      showToast("QR code scanned!", 3000);
      
      isPausedForResultDisplay = true;
      setTimeout(() => {
        isPausedForResultDisplay = false;
        resultDiv.style.display = 'none';
        showStatus("Ready to scan...");
        if (scanning) {
          scanFrame();
        }
      }, 2000);
    }

    function showDuplicateWarning() {
      showStatus("Duplicate detected!", true);
      showCurrentResult("⚠️ Duplicate QR");
      
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      duplicateWarningTimeout = setTimeout(() => {
        showStatus("Ready to scan.");
        resultDiv.style.display = 'none';
      }, 3000);
    }

    function addToHistory(content) {
      if (!content || content.startsWith("❌")) return;
      
      const timestamp = new Date().toLocaleString();
      const scanItem = {
        number: currentScanNumber++,
        content: content,
        timestamp: timestamp
      };
      
      scanHistory.push(scanItem);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
    }

    function showCurrentResult(text) {
      resultDiv.innerHTML = text;
      resultDiv.style.display = 'block';
    }

    function updateHistoryDisplay() {
      if (scanHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No scans yet</div>';
        return;
      }

      historyList.innerHTML = '';
      scanHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-item-number">${item.number}.</div>
          <div class="history-item-content">${item.content}</div>
          <div class="history-item-actions">
            <button class="history-item-btn" onclick="deleteHistoryItem(${item.number}, event)" title="Delete">✕</button>
          </div>
        `;
        historyList.appendChild(historyItem);
      });
      
      historyList.scrollTop = historyList.scrollHeight;
    }
    
    function updateHistoryCount() {
      const count = scanHistory.length;
      historyCount.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
      downloadBtn.disabled = count === 0;
      clearBtn.disabled = count === 0;
    }

    // Function to extract data from QR content
    function extractDataFromContent(content) {
      // Try to parse as JSON first
      try {
        const data = JSON.parse(content);
        return {
          fullName: data.fullName || data.name || data.Name || data.FullName || data.nama || data.Nama || "",
          phone: data.phone || data.mobile || data.Phone || data.Mobile || data.telepon || data.Telepon || "",
          gender: data.gender || data.Gender || data.jenisKelamin || data.JenisKelamin || "",
          timestamp: new Date().toLocaleString()
        };
      } catch (e) {
        // If not JSON, try to extract from text pattern
        const nameMatch = content.match(/full name[:=\s]*([^\n,]+)/i);
        const phoneMatch = content.match(/(?:phone|mobile|tel|telepon|telefono|hp|handphone)[:=\s]*([+\d\s\-()]+)/i);
        const genderMatch = content.match(/(?:gender|jenis kelamin|sex)[:=\s]*([^\n,]+)/i);
        
        // Extract name
        let extractedName = nameMatch ? nameMatch[1].trim() : "";
        
        // If no explicit name field found, try to find the first line that looks like a name
        if (!extractedName) {
          const lines = content.split('\n');
          for (const line of lines) {
            // A name typically has letters, spaces, and possibly dots for initials
            if (line.match(/^[A-Za-z\s\.]+$/) && line.trim().length > 3) {
              extractedName = line.trim();
              break;
            }
          }
        }
        
        return {
          fullName: extractedName,
          phone: phoneMatch ? phoneMatch[1].trim() : "",
          gender: genderMatch ? genderMatch[1].trim() : "",
          timestamp: new Date().toLocaleString()
        };
      }
    }

    function downloadPDF() {
      if (scanHistory.length === 0) {
        showToast("No scans to export");
        return;
      }

      try {
        // Check if jsPDF is available
        if (typeof window.jspdf === 'undefined') {
          showToast("PDF library not loaded. Using fallback method.", true);
          downloadTextFallback();
          return;
        }
        
        // Create a new jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add logo or header
        doc.setFillColor(51, 1, 31); // #33011f
        doc.rect(0, 0, 220, 20, 'F');
        doc.setFontSize(16);
        doc.setTextColor(255, 255, 255);
        doc.text("QR Code Scan Report", 105, 12, { align: "center" });
        
        // Add generation date
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        const date = new Date().toLocaleDateString();
        const time = new Date().toLocaleTimeString();
        doc.text(`Generated: ${date} ${time}`, 105, 18, { align: "center" });
        
        // Reset text color
        doc.setTextColor(0, 0, 0);
        
        // Extract data from scan history
        const tableData = scanHistory.map((item, index) => {
          const extractedData = extractDataFromContent(item.content);
          return [
            index + 1,
            extractedData.fullName || "N/A",
            extractedData.phone || "N/A",
            extractedData.gender || "N/A",
            item.timestamp
          ];
        });
        
        // Create the table
        doc.autoTable({
          head: [['#', 'Full Name', 'Phone', 'Gender', 'Date']],
          body: tableData,
          startY: 30,
          theme: 'grid',
          styles: {
            fontSize: 9,
            cellPadding: 3,
            overflow: 'linebreak'
          },
          headStyles: {
            fillColor: [51, 1, 31], // #33011f
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 10
          },
          alternateRowStyles: {
            fillColor: [241, 245, 249]
          },
          columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 40 },
            2: { cellWidth: 35 },
            3: { cellWidth: 25 },
            4: { cellWidth: 45 }
          },
          margin: { top: 25 }
        });
        
        // Add page numbers
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(`Page ${i} of ${pageCount}`, 200, 285, { align: "right" });
        }
        
        // Save the PDF - using data URI for APK compatibility
        const dateStr = new Date().toISOString().slice(0, 10);
        const pdfDataUri = doc.output('datauristring');
        
        // Create a download link
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfDataUri;
        downloadLink.download = `QR_Scan_Report_${dateStr}.pdf`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        showToast("PDF report downloaded");
        
      } catch (e) {
        console.error("PDF export error:", e);
        showToast("Error generating PDF report", true);
        
        // Fallback to text download
        downloadTextFallback();
      }
    }

    function downloadTextFallback() {
      try {
        let textContent = "QR Code Scan Report\n\n";
        textContent += "Generated on: " + new Date().toLocaleDateString() + " at " + new Date().toLocaleTimeString() + "\n\n";
        
        scanHistory.forEach((item, index) => {
          const extractedData = extractDataFromContent(item.content);
          textContent += `${index + 1}. ${extractedData.fullName || "N/A"} | ${extractedData.phone || "N/A"} | ${extractedData.gender || "N/A"} | ${item.timestamp}\n`;
        });
        
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `QR_Scan_Report_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast("Downloaded as text file instead");
      } catch (fallbackError) {
        console.error("Fallback also failed:", fallbackError);
        showToast("Export failed completely", true);
      }
    }

    function deleteHistoryItem(number, event) {
      event.stopPropagation();
      scanHistory = scanHistory.filter(i => i.number !== number);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
      showToast("Item deleted");
    }

    function clearHistory() {
      if (scanHistory.length === 0) {
        showToast("History is already empty");
        return;
      }
      
      if (confirm("Are you sure you want to clear all scan history?")) {
        scanHistory = [];
        currentScanNumber = 1;
        lastScannedContent = null;
        updateHistoryDisplay();
        updateHistoryCount();
        saveHistory();
        showToast("History cleared");
      }
    }

    function saveHistory() {
      try {
        localStorage.setItem('qrScanHistory', JSON.stringify(scanHistory));
      } catch (e) {
        console.error("Error saving history:", e);
        showToast("Error saving history", true);
      }
    }
    
    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusText.className = isError ? 'status error-text' : 'status';
    }
    
    function showToast(message, duration = 2000, isError = false) {
      toast.textContent = message;
      toast.className = isError ? 'toast error-text' : 'toast';
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      stopCamera();
      stopTimer();
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      if (scannerTimeout) {
        cancelAnimationFrame(scannerTimeout);
      }
    });

    // Initialize button states
    updateHistoryCount();
  </script>
</body>
</html>